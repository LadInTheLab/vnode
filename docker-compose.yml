services:
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun-vnode
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    networks:
      pub_net:
        ipv4_address: ${MACVLAN_IP}
    # Static MAC prevents UDM Pro ARP confusion
    mac_address: ${MACVLAN_MAC}
    sysctls:
      - net.ipv4.conf.all.rp_filter=0
      - net.ipv4.conf.default.rp_filter=0
      - net.ipv4.ip_forward=1
    environment:
      - VPN_SERVICE_PROVIDER=custom
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${VPN_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${VPN_IP}
      - WIREGUARD_PUBLIC_KEY=${VPN_PUBLIC_KEY}
      - WIREGUARD_ENDPOINT_IP=${VPN_ENDPOINT_IP}
      - WIREGUARD_ENDPOINT_PORT=${VPN_PORT}
      - WIREGUARD_ALLOWED_IPS=0.0.0.0/0
      - WIREGUARD_PERSISTENT_KEEPALIVE=${WIREGUARD_KEEPALIVE:-25}
      - DNS_KEEP_NAMESERVER=off
      - DNS_ADDRESS=${DNS_SERVER:-9.9.9.9}
      - WIREGUARD_MTU=${WIREGUARD_MTU:-1280}
      - HTTPPROXY=off
      - SHADOWSOCKS=off
      - FIREWALL_OUTBOUND_SUBNETS=100.64.0.0/10,${GATEWAY_IP}/32
    volumes:
      - ./logs/gluetun:/tmp/gluetun
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "--timeout=5", "--tries=1", "https://1.1.1.1"]
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped

  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale-vnode
    network_mode: service:gluetun
    depends_on:
      gluetun:
        condition: service_healthy
    privileged: true
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_HOSTNAME=${TS_HOSTNAME:-vnode}
      - TS_USERSPACE=false
      - TS_EXTRA_ARGS=--reset --advertise-exit-node --accept-routes --advertise-connector
      - TS_STATE_DIR=/var/lib/tailscale
      - PORT=${TUNNEL_PORT:-41641}
      - GATEWAY_IP=${GATEWAY_IP}
      - TCP_MSS_CLAMP=${TCP_MSS_CLAMP:-1120}
    volumes:
      - ./tailscale-state:/var/lib/tailscale
      - ./logs/tailscale:/var/log/tailscale
    entrypoint:
      - /bin/sh
      - -c
      - |
        echo "Starting vNode..."

        # Enable IP forwarding
        echo '1' > /proc/sys/net/ipv4/ip_forward
        echo '1' > /proc/sys/net/ipv6/conf/all/forwarding

        # Set DNS to Quad9
        umount /etc/resolv.conf 2>/dev/null || true
        echo "nameserver 9.9.9.9" > /etc/resolv.conf

        # Disable reverse path filtering on all interfaces
        # Without this, the kernel drops packets that arrive on "unexpected" interfaces
        for i in /proc/sys/net/ipv4/conf/*/rp_filter; do
          echo 0 > "$$i"
        done

        # Wait for Gluetun to bring up the VPN tunnel
        echo "Waiting for tun0..."
        until ip link show tun0 >/dev/null 2>&1; do sleep 1; done

        # Create routing table 51 for direct LAN access
        # Tailscale control traffic will use this to bypass the VPN
        ip route flush table 51 2>/dev/null || true
        ip route add default via $${GATEWAY_IP} dev eth0 table 51

        # Swap default routes: LAN becomes VPN, VPN becomes conditional
        # This is the core of the split routing - client traffic goes to VPN by default
        ip route del default table main 2>/dev/null || true
        ip route add default dev tun0 table main

        # Policy routing: marked packets use table 51 (direct LAN)
        ip rule del fwmark 0x40000 2>/dev/null || true
        ip rule add fwmark 0x40000 lookup 51 prio 1

        # Mark Tailscale control traffic (DERP relays and direct connections)
        # Marked packets get routed via table 51, avoiding the VPN tunnel
        iptables -t mangle -I OUTPUT 1 -p udp --dport 3478 -j MARK --set-mark 0x40000
        iptables -t mangle -I OUTPUT 1 -p udp --sport 3478 -j MARK --set-mark 0x40000
        iptables -t mangle -I OUTPUT 1 -p udp --sport $${PORT} -j MARK --set-mark 0x40000
        iptables -t mangle -I OUTPUT 1 -p udp --dport $${PORT} -j MARK --set-mark 0x40000

        # NAT rules
        iptables -P FORWARD ACCEPT
        iptables -t nat -A POSTROUTING -o tun0 -j MASQUERADE
        iptables -t nat -A POSTROUTING -o eth0 -m mark --mark 0x40000 -j MASQUERADE

        # TCP MSS clamping to avoid MTU issues with double WireGuard encapsulation
        iptables -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss $${TCP_MSS_CLAMP}

        # Background task: wait for tailscale0, then add return path rule
        # Tailscale creates table 52 at runtime - we need to route Tailscale IPs back through it
        (
          until ip link show tailscale0 >/dev/null 2>&1; do sleep 1; done
          sleep 5
          ip rule add to 100.64.0.0/10 lookup 52 priority 99
          echo "Return path routing active"
        ) &

        /usr/local/bin/containerboot
    restart: unless-stopped

networks:
  pub_net:
    name: ${MACVLAN_NETWORK:-pub_net}
    external: true