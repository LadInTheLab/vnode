#!/bin/bash
#
# vnode - Tailscale Virtual Exit Node Manager
# Unified CLI for managing vNode instances
#

set -euo pipefail

# Load configuration
CONFIG_FILE="${VNODE_CONFIG_DIR:-$HOME/.config/vnode}/config"
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
else
    INSTALL_DIR="${VNODE_INSTALL_DIR:-/opt/vnode}"
    INSTANCES_DIR="${VNODE_INSTANCES_DIR:-$HOME/.local/share/vnode/instances}"
    CONFIG_DIR="${VNODE_CONFIG_DIR:-$HOME/.config/vnode}"
fi

# Colors - only use if terminal supports them
if [ -t 1 ] && command -v tput >/dev/null 2>&1 && [ "$(tput colors 2>/dev/null || echo 0)" -ge 8 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    MAGENTA='\033[0;35m'
    GRAY='\033[0;90m'
    NC='\033[0m'
    BOLD='\033[1m'
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    CYAN=''
    MAGENTA=''
    GRAY=''
    NC=''
    BOLD=''
fi

# Helper functions
info() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[✓]${NC} $1"; }
warning() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[✗]${NC} $1"; }
fatal() { error "$1"; exit 1; }

# Show help
show_help() {
    printf "%b" "\
${BOLD}vnode${NC} - Tailscale Virtual Exit Node Manager

${CYAN}USAGE:${NC}
  vnode <command> [options]

${CYAN}INSTANCE MANAGEMENT:${NC}
  ${GREEN}create [name]${NC}              Create new instance (interactive wizard)
  ${GREEN}list${NC}                       List all instances
  ${GREEN}start <name>|all${NC}           Start instance(s)
  ${GREEN}stop <name>|all${NC}            Stop instance(s)
  ${GREEN}restart <name>|all${NC}         Restart instance(s)
  ${GREEN}status [name]${NC}              Show instance status
  ${GREEN}delete <name>${NC}              Delete instance
  ${GREEN}logs <name> [follow]${NC}       View logs (add 'follow' for tail -f)

${CYAN}MONITORING:${NC}
  ${GREEN}health [name]${NC}              Health check on instance(s)
  ${GREEN}monitor <name>${NC}             Live dashboard (refreshes every 5s)
  ${GREEN}ip <name>${NC}                  Show VPN exit IP

${CYAN}MAINTENANCE:${NC}
  ${GREEN}update [name]${NC}              Pull latest images and restart
  ${GREEN}shell <name> [container]${NC}   Shell access (gluetun/tailscale)
  ${GREEN}check-updates [name]${NC}       Check for available updates

${CYAN}CONFIGURATION:${NC}
  ${GREEN}config <name> [edit]${NC}       View/edit instance config
  ${GREEN}validate <name>${NC}            Validate instance config
  ${GREEN}info${NC}                       Show installation info

${CYAN}SYSTEM:${NC}
  ${GREEN}doctor${NC}                     Check system dependencies
  ${GREEN}version${NC}                    Show vnode version
  ${GREEN}help${NC}                       Show this help

${CYAN}EXAMPLES:${NC}
  vnode create us-east             Create instance
  vnode start us-east              Start instance
  vnode status                     Show all instances
  vnode health us-east             Health check
  vnode monitor us-east            Live dashboard
  vnode logs us-east follow        Follow logs
  vnode update all                 Update all instances

${CYAN}DOCUMENTATION:${NC}
  README.md     Overview and quick start
  GUIDE.md      Installation and configuration
  ADVANCED.md   Multi-instance and networking
"
}

# Instance management helpers
instance_exists() {
    local name=$1
    [ -d "$INSTANCES_DIR/$name" ]
}

get_instances() {
    if [ -d "$INSTANCES_DIR" ]; then
        find "$INSTANCES_DIR" -mindepth 1 -maxdepth 1 -type d -exec basename {} \;
    fi
}

get_compose_cmd() {
    if docker compose version >/dev/null 2>&1; then
        echo "docker compose"
    else
        echo "docker-compose"
    fi
}

# Create new instance
cmd_create() {
    local name="${1:-}"

    if [ -z "$name" ]; then
        read -p "Enter instance name (e.g., us-east, eu-west): " name
        name=$(echo "$name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
    fi

    if [ -z "$name" ]; then
        fatal "Instance name is required"
    fi

    if instance_exists "$name"; then
        fatal "Instance '$name' already exists"
    fi

    info "Creating instance: $name"

    local instance_dir="$INSTANCES_DIR/$name"
    mkdir -p "$instance_dir"

    cp -r "$INSTALL_DIR"/{docker-compose.yml,.env.template,.gitignore,scripts} "$instance_dir/"
    chmod +x "$instance_dir"/scripts/*.sh

    success "Instance directory created at $instance_dir"
    echo ""

    info "Starting interactive setup wizard..."
    echo ""
    cd "$instance_dir"
    ./scripts/setup-wizard.sh

    success "Instance '$name' created!"
    echo ""
    echo "Next steps:"
    echo "  vnode start $name       Start the instance"
    echo "  vnode health $name      Check health"
    echo "  vnode monitor $name     Open dashboard"
}

# List instances
cmd_list() {
    local instances=($(get_instances))

    if [ ${#instances[@]} -eq 0 ]; then
        warning "No instances found"
        echo ""
        echo "Create one with: vnode create <name>"
        return
    fi

    echo -e "${BOLD}Instances:${NC}\n"

    for instance in "${instances[@]}"; do
        local instance_dir="$INSTANCES_DIR/$instance"
        local status="stopped"
        local color="$GRAY"

        cd "$instance_dir"
        local compose_cmd=$(get_compose_cmd)
        if $compose_cmd ps 2>/dev/null | grep -q "Up"; then
            status="running"
            color="$GREEN"
        fi

        if [ -f "$instance_dir/.env" ]; then
            local hostname=$(grep "^TS_HOSTNAME=" "$instance_dir/.env" 2>/dev/null | cut -d'=' -f2 | tr -d '"' || echo "N/A")
            local ip=$(grep "^MACVLAN_IP=" "$instance_dir/.env" 2>/dev/null | cut -d'=' -f2 | tr -d '"' || echo "N/A")
            echo -e "  ${color}●${NC} ${BOLD}$instance${NC} ($status)"
            echo -e "    Hostname: $hostname"
            echo -e "    IP:       $ip"
            echo -e "    Path:     $instance_dir"
        else
            echo -e "  ${color}●${NC} ${BOLD}$instance${NC} ($status)"
            echo -e "    ${YELLOW}Not configured${NC}"
        fi
        echo ""
    done
}

# Start instance(s)
cmd_start() {
    local name="${1:-}"

    if [ -z "$name" ]; then
        fatal "Instance name required. Use 'all' for all instances."
    fi

    if [ "$name" = "all" ]; then
        local instances=($(get_instances))
        for instance in "${instances[@]}"; do
            info "Starting $instance..."
            cd "$INSTANCES_DIR/$instance"
            local compose_cmd=$(get_compose_cmd)
            if $compose_cmd up -d; then
                success "$instance started"
            else
                error "Failed to start $instance"
            fi
        done
    else
        if ! instance_exists "$name"; then
            fatal "Instance '$name' not found"
        fi
        info "Starting $name..."
        cd "$INSTANCES_DIR/$name"
        local compose_cmd=$(get_compose_cmd)
        if $compose_cmd up -d; then
            success "$name started"
        else
            fatal "Failed to start $name"
        fi
    fi
}

# Stop instance(s)
cmd_stop() {
    local name="${1:-}"

    if [ -z "$name" ]; then
        fatal "Instance name required. Use 'all' for all instances."
    fi

    if [ "$name" = "all" ]; then
        local instances=($(get_instances))
        for instance in "${instances[@]}"; do
            info "Stopping $instance..."
            cd "$INSTANCES_DIR/$instance"
            local compose_cmd=$(get_compose_cmd)
            $compose_cmd stop >/dev/null 2>&1
            success "$instance stopped"
        done
    else
        if ! instance_exists "$name"; then
            fatal "Instance '$name' not found"
        fi
        info "Stopping $name..."
        cd "$INSTANCES_DIR/$name"
        local compose_cmd=$(get_compose_cmd)
        $compose_cmd stop >/dev/null 2>&1
        success "$name stopped"
    fi
}

# Restart instance(s)
cmd_restart() {
    local name="${1:-}"

    if [ -z "$name" ]; then
        fatal "Instance name required. Use 'all' for all instances."
    fi

    if [ "$name" = "all" ]; then
        local instances=($(get_instances))
        for instance in "${instances[@]}"; do
            info "Restarting $instance..."
            cd "$INSTANCES_DIR/$instance"
            local compose_cmd=$(get_compose_cmd)
            $compose_cmd restart >/dev/null 2>&1
            success "$instance restarted"
        done
    else
        if ! instance_exists "$name"; then
            fatal "Instance '$name' not found"
        fi
        info "Restarting $name..."
        cd "$INSTANCES_DIR/$name"
        local compose_cmd=$(get_compose_cmd)
        $compose_cmd restart >/dev/null 2>&1
        success "$name restarted"
    fi
}

# Show status
cmd_status() {
    local name="${1:-}"

    if [ -n "$name" ]; then
        if ! instance_exists "$name"; then
            fatal "Instance '$name' not found"
        fi
        echo -e "${BOLD}Status: $name${NC}\n"
        cd "$INSTANCES_DIR/$name"
        local compose_cmd=$(get_compose_cmd)
        $compose_cmd ps
    else
        local instances=($(get_instances))
        if [ ${#instances[@]} -eq 0 ]; then
            warning "No instances found"
            return
        fi
        for instance in "${instances[@]}"; do
            echo -e "${BOLD}=== $instance ===${NC}"
            cd "$INSTANCES_DIR/$instance"
            local compose_cmd=$(get_compose_cmd)
            $compose_cmd ps
            echo ""
        done
    fi
}

# Delete instance
cmd_delete() {
    local name="${1:-}"

    if [ -z "$name" ]; then
        fatal "Instance name required"
    fi

    if ! instance_exists "$name"; then
        fatal "Instance '$name' not found"
    fi

    warning "This will delete instance '$name' and all its data"
    read -p "Type 'yes' to confirm: " -r
    if [[ $REPLY != "yes" ]]; then
        info "Cancelled"
        return
    fi

    info "Stopping containers..."
    cd "$INSTANCES_DIR/$name"
    local compose_cmd=$(get_compose_cmd)
    $compose_cmd down -v 2>/dev/null || true

    info "Removing instance directory..."
    rm -rf "$INSTANCES_DIR/$name"

    success "Instance '$name' deleted"
}

# View logs
cmd_logs() {
    local name="${1:-}"
    local follow="${2:-}"

    if [ -z "$name" ]; then
        fatal "Instance name required"
    fi

    if ! instance_exists "$name"; then
        fatal "Instance '$name' not found"
    fi

    cd "$INSTANCES_DIR/$name"
    local compose_cmd=$(get_compose_cmd)

    if [ "$follow" = "follow" ] || [ "$follow" = "-f" ]; then
        $compose_cmd logs -f --tail=100
    else
        $compose_cmd logs --tail=100
    fi
}

# Health check
cmd_health() {
    local name="${1:-}"

    if [ -n "$name" ]; then
        if ! instance_exists "$name"; then
            fatal "Instance '$name' not found"
        fi
        _do_health_check "$name"
    else
        local instances=($(get_instances))
        if [ ${#instances[@]} -eq 0 ]; then
            warning "No instances found"
            return
        fi
        for instance in "${instances[@]}"; do
            echo -e "${BOLD}=== $instance ===${NC}"
            _do_health_check "$instance"
            echo ""
        done
    fi
}

_do_health_check() {
    local name=$1
    local instance_dir="$INSTANCES_DIR/$name"
    cd "$instance_dir"

    local overall_status="healthy"
    local issues=()

    echo -e "\n${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}  Health Check: $name${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"

    # Check Gluetun
    local gluetun_status=$(docker inspect -f '{{.State.Status}}' gluetun-vnode 2>/dev/null || echo "not-found")
    local gluetun_health=$(docker inspect -f '{{.State.Health.Status}}' gluetun-vnode 2>/dev/null || echo "none")

    echo -e "${BOLD}Containers:${NC}"
    printf "  Gluetun:   %-10s " "$gluetun_status"
    if [ "$gluetun_status" = "running" ]; then
        echo -e "${GREEN}✓${NC}"
    else
        echo -e "${RED}✗${NC}"
        overall_status="critical"
        issues+=("Gluetun not running")
    fi

    if [ "$gluetun_health" != "none" ]; then
        printf "  Health:    %-10s " "$gluetun_health"
        if [ "$gluetun_health" = "healthy" ]; then
            echo -e "${GREEN}✓${NC}"
        else
            echo -e "${YELLOW}⚠${NC}"
            overall_status="degraded"
            issues+=("Gluetun unhealthy")
        fi
    fi

    # Check Tailscale
    local tailscale_status=$(docker inspect -f '{{.State.Status}}' tailscale-vnode 2>/dev/null || echo "not-found")
    printf "  Tailscale: %-10s " "$tailscale_status"
    if [ "$tailscale_status" = "running" ]; then
        echo -e "${GREEN}✓${NC}"
    else
        echo -e "${RED}✗${NC}"
        overall_status="critical"
        issues+=("Tailscale not running")
    fi

    # Check VPN connectivity
    echo -e "\n${BOLD}Connectivity:${NC}"
    local vpn_ip=$(docker exec gluetun-vnode wget -qO- https://api.ipify.org 2>/dev/null || echo "error")
    printf "  VPN IP:    %s" "$vpn_ip"
    if [[ "$vpn_ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo -e " ${GREEN}✓${NC}"
    else
        echo -e " ${RED}✗${NC}"
        overall_status="critical"
        issues+=("Cannot reach internet through VPN")
    fi

    # Check Tailscale online status
    if [ "$tailscale_status" = "running" ]; then
        local ts_online=$(docker exec tailscale-vnode tailscale status --json 2>/dev/null | jq -r '.Self.Online // "false"')
        printf "  Tailscale: "
        if [ "$ts_online" = "true" ]; then
            echo -e "${GREEN}● Online${NC}"
        else
            echo -e "${RED}● Offline${NC}"
            overall_status="degraded"
            issues+=("Tailscale offline")
        fi
    fi

    # Show overall status
    echo ""
    case $overall_status in
        healthy) echo -e "Status: ${GREEN}✓ HEALTHY${NC}" ;;
        degraded) echo -e "Status: ${YELLOW}⚠ DEGRADED${NC}" ;;
        critical) echo -e "Status: ${RED}✗ CRITICAL${NC}" ;;
    esac

    # Show issues if any
    if [ ${#issues[@]} -gt 0 ]; then
        echo -e "\n${YELLOW}Issues:${NC}"
        for issue in "${issues[@]}"; do
            echo -e "  ${RED}•${NC} $issue"
        done
    fi

    echo -e "\n${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"
}

# Monitor dashboard
cmd_monitor() {
    local name="${1:-}"

    if [ -z "$name" ]; then
        fatal "Instance name required"
    fi

    if ! instance_exists "$name"; then
        fatal "Instance '$name' not found"
    fi

    local instance_dir="$INSTANCES_DIR/$name"

    trap 'echo -e "\n${NC}Exiting..."; exit 0' INT

    while true; do
        clear

        echo -e "${BLUE}${BOLD}╔════════════════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${BLUE}${BOLD}║${NC}          ${CYAN}${BOLD}Monitor: $name${NC}                                             ${BLUE}${BOLD}║${NC}"
        echo -e "${BLUE}${BOLD}╚════════════════════════════════════════════════════════════════════════╝${NC}\n"

        echo -e "${GRAY}Updated: $(date '+%Y-%m-%d %H:%M:%S')${NC}\n"

        # Container status
        echo -e "${BOLD}CONTAINERS${NC}"
        echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

        local gluetun_status=$(docker inspect -f '{{.State.Status}}' gluetun-vnode 2>/dev/null || echo "not-found")
        local gluetun_health=$(docker inspect -f '{{.State.Health.Status}}' gluetun-vnode 2>/dev/null || echo "none")

        echo -n "  Gluetun VPN:     "
        if [ "$gluetun_status" = "running" ]; then
            echo -e "${GREEN}● Running${NC}"
        else
            echo -e "${RED}● $gluetun_status${NC}"
        fi

        echo -n "  Health:          "
        case $gluetun_health in
            healthy) echo -e "${GREEN}✓ Healthy${NC}" ;;
            unhealthy) echo -e "${RED}✗ Unhealthy${NC}" ;;
            starting) echo -e "${YELLOW}⟳ Starting${NC}" ;;
            *) echo -e "${GRAY}N/A${NC}" ;;
        esac

        if [ "$gluetun_status" = "running" ]; then
            local gluetun_stats=$(docker stats gluetun-vnode --no-stream --format "{{.CPUPerc}}|{{.MemUsage}}|{{.NetIO}}" 2>/dev/null || echo "N/A|N/A|N/A")
            IFS='|' read -r cpu mem net <<< "$gluetun_stats"
            echo -e "  CPU:             $cpu"
            echo -e "  Memory:          $mem"
            echo -e "  Network I/O:     $net"
        fi

        echo ""

        local tailscale_status=$(docker inspect -f '{{.State.Status}}' tailscale-vnode 2>/dev/null || echo "not-found")

        echo -n "  Tailscale:       "
        if [ "$tailscale_status" = "running" ]; then
            echo -e "${GREEN}● Running${NC}"
        else
            echo -e "${RED}● $tailscale_status${NC}"
        fi

        if [ "$tailscale_status" = "running" ]; then
            local tailscale_stats=$(docker stats tailscale-vnode --no-stream --format "{{.CPUPerc}}|{{.MemUsage}}|{{.NetIO}}" 2>/dev/null || echo "N/A|N/A|N/A")
            IFS='|' read -r cpu mem net <<< "$tailscale_stats"
            echo -e "  CPU:             $cpu"
            echo -e "  Memory:          $mem"
            echo -e "  Network I/O:     $net"
        fi

        # Connectivity
        echo -e "\n${BOLD}CONNECTIVITY${NC}"
        echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

        local vpn_ip=$(docker exec gluetun-vnode wget -qO- https://api.ipify.org 2>/dev/null || echo "error")
        echo -n "  Exit IP:         "
        if [[ "$vpn_ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo -e "${GREEN}$vpn_ip${NC}"
        else
            echo -e "${RED}Error${NC}"
        fi

        if [ "$tailscale_status" = "running" ]; then
            local ts_info=$(docker exec tailscale-vnode tailscale status --json 2>/dev/null || echo "{}")
            local ts_online=$(echo "$ts_info" | jq -r '.Self.Online // "unknown"' 2>/dev/null)
            local ts_hostname=$(echo "$ts_info" | jq -r '.Self.HostName // "unknown"' 2>/dev/null)
            local ts_ip=$(echo "$ts_info" | jq -r '.Self.TailscaleIPs[0] // "unknown"' 2>/dev/null)
            local peer_count=$(echo "$ts_info" | jq '[.Peer | to_entries[] | select(.value.Active == true)] | length' 2>/dev/null || echo "0")

            echo -n "  Tailscale:       "
            if [ "$ts_online" = "true" ]; then
                echo -e "${GREEN}● Online${NC}"
            else
                echo -e "${RED}● Offline${NC}"
            fi

            echo -e "  Hostname:        $ts_hostname"
            echo -e "  Tailscale IP:    $ts_ip"
            echo -e "  Active peers:    $peer_count"
        fi

        # Recent logs
        echo -e "\n${BOLD}RECENT LOGS${NC}"
        echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

        if [ "$gluetun_status" = "running" ]; then
            echo -e "${GRAY}Gluetun:${NC}"
            docker logs --tail 3 gluetun-vnode 2>&1 | sed 's/^/  /' | cut -c1-72
        fi

        if [ "$tailscale_status" = "running" ]; then
            echo -e "${GRAY}Tailscale:${NC}"
            docker logs --tail 3 tailscale-vnode 2>&1 | sed 's/^/  /' | cut -c1-72
        fi

        echo -e "\n${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${GRAY}Press Ctrl+C to exit | Refreshing every 5 seconds...${NC}"

        sleep 5
    done
}

# Show VPN IP
cmd_ip() {
    local name="${1:-}"

    if [ -z "$name" ]; then
        fatal "Instance name required"
    fi

    if ! instance_exists "$name"; then
        fatal "Instance '$name' not found"
    fi

    echo -n "VPN exit IP: "
    local ip=$(docker exec gluetun-vnode wget -qO- https://api.ipify.org 2>/dev/null || echo "error")
    if [[ "$ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo -e "${GREEN}$ip${NC}"
    else
        echo -e "${RED}Unable to retrieve IP${NC}"
        exit 1
    fi
}

# Update containers
cmd_update() {
    local name="${1:-}"

    if [ -n "$name" ] && [ "$name" != "all" ]; then
        if ! instance_exists "$name"; then
            fatal "Instance '$name' not found"
        fi
        _do_update "$name"
    else
        local instances=($(get_instances))
        if [ ${#instances[@]} -eq 0 ]; then
            warning "No instances found"
            return
        fi
        for instance in "${instances[@]}"; do
            echo -e "${BOLD}=== Updating $instance ===${NC}"
            _do_update "$instance"
            echo ""
        done
    fi
}

_do_update() {
    local name=$1
    cd "$INSTANCES_DIR/$name"
    local compose_cmd=$(get_compose_cmd)

    info "Pulling latest images..."
    if $compose_cmd pull; then
        success "Images updated"
        info "Restarting containers..."
        if $compose_cmd up -d; then
            success "Containers restarted"
        else
            error "Failed to restart containers"
        fi
    else
        error "Failed to pull images"
    fi
}

# Shell access
cmd_shell() {
    local name="${1:-}"
    local container="${2:-gluetun}"

    if [ -z "$name" ]; then
        fatal "Instance name required"
    fi

    if ! instance_exists "$name"; then
        fatal "Instance '$name' not found"
    fi

    case "$container" in
        gluetun|g)
            info "Opening shell in Gluetun container..."
            docker exec -it gluetun-vnode /bin/sh
            ;;
        tailscale|t)
            info "Opening shell in Tailscale container..."
            docker exec -it tailscale-vnode /bin/sh
            ;;
        *)
            fatal "Invalid container. Use: gluetun or tailscale"
            ;;
    esac
}

# Check for updates
cmd_check_updates() {
    local name="${1:-}"

    if [ -n "$name" ]; then
        if ! instance_exists "$name"; then
            fatal "Instance '$name' not found"
        fi
        cd "$INSTANCES_DIR/$name"
        if [ -f "./scripts/check-updates.sh" ]; then
            ./scripts/check-updates.sh
        else
            warning "check-updates.sh not found"
        fi
    else
        local instances=($(get_instances))
        if [ ${#instances[@]} -eq 0 ]; then
            warning "No instances found"
            return
        fi
        for instance in "${instances[@]}"; do
            echo -e "${BOLD}=== $instance ===${NC}"
            cd "$INSTANCES_DIR/$instance"
            if [ -f "./scripts/check-updates.sh" ]; then
                ./scripts/check-updates.sh
            fi
            echo ""
        done
    fi
}

# View/edit configuration
cmd_config() {
    local name="${1:-}"
    local action="${2:-view}"

    if [ -z "$name" ]; then
        fatal "Instance name required"
    fi

    if ! instance_exists "$name"; then
        fatal "Instance '$name' not found"
    fi

    local config_file="$INSTANCES_DIR/$name/.env"

    if [ ! -f "$config_file" ]; then
        fatal "Configuration file not found"
    fi

    case "$action" in
        view)
            cat "$config_file" | sed 's/\(KEY=\).*$/\1***REDACTED***/; s/\(AUTHKEY=\).*$/\1***REDACTED***/'
            ;;
        edit)
            ${EDITOR:-nano} "$config_file"
            info "Configuration updated. Restart to apply: vnode restart $name"
            ;;
        *)
            fatal "Invalid action. Use: view or edit"
            ;;
    esac
}

# Validate configuration
cmd_validate() {
    local name="${1:-}"

    if [ -z "$name" ]; then
        fatal "Instance name required"
    fi

    if ! instance_exists "$name"; then
        fatal "Instance '$name' not found"
    fi

    cd "$INSTANCES_DIR/$name"
    if [ -f "./scripts/deploy.sh" ]; then
        ./scripts/deploy.sh --validate-only
    else
        warning "deploy.sh not found"
    fi
}

# Show installation info
cmd_info() {
    echo -e "${BOLD}vNode Installation Info:${NC}\n"
    echo -e "  Install Directory:    $INSTALL_DIR"
    echo -e "  Config Directory:     $CONFIG_DIR"
    echo -e "  Instances Directory:  $INSTANCES_DIR"
    echo -e "  CLI Location:         $(which vnode 2>/dev/null || echo 'not in PATH')"
    echo ""
    echo -e "${BOLD}Instances:${NC}"
    local count=$(get_instances | wc -l | tr -d ' ')
    echo -e "  Total: $count"
    echo ""
    echo -e "${BOLD}Documentation:${NC}"
    echo -e "  README.md     Quick start and overview"
    echo -e "  GUIDE.md      Installation and configuration"
    echo -e "  ADVANCED.md   Multi-instance and networking"
}

# Show version
cmd_version() {
    if [ -f "$CONFIG_FILE" ]; then
        local version=$(grep "^VERSION=" "$CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 | tr -d '"' || echo "unknown")
        echo "vnode version $version"
    else
        echo "vnode (version unknown)"
    fi
}

# System check
cmd_doctor() {
    echo -e "${BOLD}vnode System Check${NC}\n"

    # Check Docker
    if command -v docker >/dev/null 2>&1; then
        if docker info >/dev/null 2>&1; then
            echo -e "${GREEN}✓${NC} Docker installed and running"
        else
            echo -e "${YELLOW}!${NC} Docker installed but not running"
        fi
    else
        echo -e "${RED}✗${NC} Docker not installed"
    fi

    # Check Docker Compose
    if docker compose version >/dev/null 2>&1; then
        echo -e "${GREEN}✓${NC} Docker Compose available (v2)"
    elif command -v docker-compose >/dev/null 2>&1; then
        echo -e "${GREEN}✓${NC} Docker Compose available (v1)"
    else
        echo -e "${RED}✗${NC} Docker Compose not found"
    fi

    # Check dependencies
    for cmd in curl wget jq; do
        if command -v "$cmd" >/dev/null 2>&1; then
            echo -e "${GREEN}✓${NC} $cmd installed"
        else
            echo -e "${YELLOW}!${NC} $cmd not found (optional)"
        fi
    done

    # Check directories
    echo ""
    echo -e "${BOLD}Directories:${NC}"
    for dir in "$INSTALL_DIR" "$CONFIG_DIR" "$INSTANCES_DIR"; do
        if [ -d "$dir" ]; then
            echo -e "${GREEN}✓${NC} $dir"
        else
            echo -e "${RED}✗${NC} $dir (missing)"
        fi
    done

    # Check instances
    echo ""
    echo -e "${BOLD}Instances:${NC}"
    local instances=($(get_instances))
    if [ ${#instances[@]} -gt 0 ]; then
        for instance in "${instances[@]}"; do
            echo -e "${GREEN}✓${NC} $instance"
        done
    else
        echo -e "${GRAY}No instances created${NC}"
    fi
}

# Main command router
main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        create) cmd_create "$@" ;;
        list|ls) cmd_list "$@" ;;
        start) cmd_start "$@" ;;
        stop) cmd_stop "$@" ;;
        restart) cmd_restart "$@" ;;
        status) cmd_status "$@" ;;
        delete|remove|rm) cmd_delete "$@" ;;
        logs) cmd_logs "$@" ;;
        health) cmd_health "$@" ;;
        monitor) cmd_monitor "$@" ;;
        ip) cmd_ip "$@" ;;
        update) cmd_update "$@" ;;
        check-updates) cmd_check_updates "$@" ;;
        shell|exec) cmd_shell "$@" ;;
        config) cmd_config "$@" ;;
        validate) cmd_validate "$@" ;;
        info) cmd_info "$@" ;;
        version|-v|--version) cmd_version "$@" ;;
        doctor) cmd_doctor "$@" ;;
        help|-h|--help) show_help "$@" ;;
        *)
            error "Unknown command: $cmd"
            echo ""
            echo "Run 'vnode help' for usage information"
            exit 1
            ;;
    esac
}

main "$@"
